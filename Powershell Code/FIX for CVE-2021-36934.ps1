# FIX for CVE-2021-36934
# CVE: https://msrc.microsoft.com/update-guide/vulnerability/CVE-2021-36934
# Based on Reddit from the work of JoranSlingerland: https://www.reddit.com/r/sysadmin/comments/oopkwx/script_to_fix_cve202136934/
# Original GitHub script: https://github.com/JoranSlingerland/CVE-2021-36934
# 
# Date: 22.07.2021
# Development: TDA
# Version: 1.0
# 
# Initial Changelog:
# - Log functions
# - Each step is a function

function Write-Log
{
    [CmdletBinding()]
    param
    (
        [String]$Message,
        [String]$Warning,
        [System.Management.Automation.ErrorRecord]$ErrorObj,
        [String]$LogFolderPath = "$env:windir\Logs",
        [String]$LogFilePrefix = 'CVE-2021-36934'
    )
 
    $Date = Get-Date -Format "dd.MM.yyyy.HHmm"
    $Time = Get-Date -Format "HH:mm:ss.f"
    $LogFile = "$LogFolderPath\$LogFilePrefix`_$Date.log"
 
    if (-not (Test-Path -Path $LogFolderPath))
    {
        [Void](New-Item -ItemType Directory -Path $LogFolderPath -Force)
    }
 
    if (-not (Test-Path -Path $LogFile))
    {
        [Void](New-Item -ItemType File -Path $LogFile -Force)
    }
 
    $LogMessage = "[$Time] "
 
    if ($PSBoundParameters.ContainsKey("ErrorObj"))
    {
        $LogMessage += "Error: $ErrorObj $($ErrorObj.ScriptStackTrace.Split("`n") -join ' <-- ')"
        Write-Error -Message $LogMessage
    }
    elseif ($PSBoundParameters.ContainsKey("Warning"))
    {
        $LogMessage += "Warning: $Warning"
        Write-Warning -Message $LogMessage
    }
    else
    {
        $LogMessage += "Info: $Message"
        Write-Verbose -Message $LogMessage
    }
 
    Add-Content -Path $LogFile -Value "$LogMessage"
}


Function Check-CVE-2021-36934 {

$LocalUsersGroup = Get-LocalGroup -SID 'S-1-5-32-545'
$vulnerable = $false
$CheckPermissionSAM = Get-Acl $env:windir\System32\Config\sam
$CheckPermissionSEC = Get-Acl $env:windir\System32\Config\SECURITY
$CheckPermissionSYS = Get-Acl $env:windir\System32\Config\SYSTEM

if ($vulnerable -eq $false) {
    if ($CheckPermissionSAM.Access.IdentityReference -match $LocalUsersGroup.Name) {
        $vulnerableSAM = $true
    }

    if ($CheckPermissionSEC.Access.IdentityReference -match $LocalUsersGroup.Name) {
        $vulnerableSEC = $true
    }

    if ($CheckPermissionSYS.Access.IdentityReference -match $LocalUsersGroup.Name) {
        $vulnerableSYS = $true
    }

}

if (($vulnerableSAM -or $vulnerableSEC -or $vulnerableSYS) -contains $true) {
    $vulnerable = $true
    return $vulnerable
}
else {
    $vulnerable = $false
    return $vulnerable
}
}


Function Check-ShadowCopy {
    Get-CimInstance Win32_ShadowStorage -Property Volume
}

Function Delete-Shadowcopies {
    vssadmin delete shadows /quiet /all
}

Function Create-Shadowcopies {
    Invoke-CimMethod -MethodName Create -ClassName Win32_ShadowCopy -Arguments @{ Volume= "C:\\" }
}

Function Fix-ACLS {
    $ConfigFolder = "$env:windir\System32\Config"
    $inheritance = Get-Acl -Path $ConfigFolder
    $inheritance.SetAccessRuleProtection($true,$true)
    Set-Acl -Path $ConfigFolder -AclObject $inheritance 
}


if (Check-CVE-2021-36934 -eq $true) {
    Write-Log -Message "================================"
    Write-Log -Message ".:CVE-2021-36934 Checking Tool:."
    Write-Log -Message "================================"
    Write-Log -Warning "CVE-2021-36934 Present"
    Write-Log -Message "Fixing exploit"
    if (Check-ShadowCopy -eq $true) {
        try {
            Write-Log -Message "Shadow Copies detected, deleting it"
            Delete-Shadowcopies
            Write-Log -Message "Shadow Copies deleted"
            Write-Log -Message "Fixing ACLs"
            Fix-ACLS
            Write-Log -Message "ACLs fixed"
            Write-Log -Message "Creating Shadowcopy"
            Create-Shadowcopies
            Write-Log -Message "Shadowcopy created"
        }
        catch {
            Write-Log -ErrorObj $_
        }       
    }
    else {
        Write-Log -Message "Fixing ACLs"
        Fix-ACLS
        Write-Log -Message "ACLs fixed"
    }
}
else {
    Write-Log -Message "================================"
    Write-Log -Message ".:CVE-2021-36934 Checking Tool:."
    Write-Log -Message "================================"
    Write-Log -Message "CVE-2021-36934 NOT Present, you are safe"
}